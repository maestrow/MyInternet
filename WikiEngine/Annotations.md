# Аннотирование статей

> Аннотирование - процесс классификации (описания) публикаций с помощью ссылок, тэгов, свойств и интерфейсов.
Кроме того, для классификации можно использовать иерархичность публикаций, т.е. указав родителя.

Ссылки бывают внутренние и внешние. Внутренние указывают на статьи, внешние - на ресурсы.


## Внутренние ссылки и тэги

По способу представления тэг не отличается от внутренней ссылки (тэг указывает на статью), но отличается от нее по смыслу: Тэг - это не просто указание на какую-либо статью, это указание более общей категории, к которой относится тема данной статьи.

Внутренние ссылки и тэги хранятся в таблице со следующими полями:

- Тип: ссылки или тэг
- Исходная публикация
- Указываемая публикация

Т.о. ссылка становится частью метаданных, которые можно использовать при поиске.


## Ссылки на ресурсы

В системе существует отдельная таблица для ресурсов: 

- id, 
- URL, 
- Description
- idPublication - ссылка на публикацию. 

Новая запись в этой таблице создается при указании в статье новой внешней ссылки, либо при сохранении ссылки через закладку браузера.

При сохранении ссылки через закладку можно указать описание и тэги.   


### Проблема: уникальность имени файла и пустые директории

Если при аннотировании ресурса будет создаваться пустая директория, то это не удобно по двум причинам:

1. Имя директории должно быть уникальным и должно содержать только разрешенные символы, следовательно URL в качестве имени не подходит (из-за символов), заголовок веб-странички - тоже (из-за уникальности). 
2. В корне появится множество пустых директорий, нужных только для аннотирования ресурса и больше ни для чего.

Способы решения проблемы: 

1. Общая таблица публикаций разного типа (статей, ресурсов и других, реализующих различные интерфейсы), связанная с таблицей файлов filetable. Именно с этой общей таблицей публикаций будут работать таблицы аннотаций. Не каждая публикация будет иметь ссылку на файл, ресурсы не будут иметь такую ссылку, чтобы не захламлять директорию filetable.

Схема общей таблицы публикаций:

- id
- parent_id
- title
- aliases
- URL
- stream_id

Фактически данная таблица становится основной, а таблица filetable - лишь свойством статей.


## Варианты использования


### Нужна ли возможность аннотировать ресурсы?

То, что нужно иметь возможность аннотировать статьи - сомнений не вызывает. 
Нужна ли возможность аннотировать ресурсы? Нужна при следующем варианте использования: Исследуя интернет я пожелал сохранить ссылку, так как это делается во множестве сервисов закладок (вроде delicious). В этом случае ссылку нужно аннотировать.
Однако если мы вставляем в статью ссылку на отсутствующий в нашей БЗ ресурс, то данный ресурс будет создан в БД без аннотаций, даже если саму статью мы аннотировали.  

Рассмотрим варианты поиска при следующих вариантах использования: 

1. Создана статья, в которую помещены новые ссылки. При сохранении для каждой ссылки будет создан отдельный ресурс. Статья аннотирована, ресурсы - нет. При поиске по тэгам мы находим статью, в ней - нужные ссылки.
2. Если ссылка используется в нескольких статьях, то она может быть найдена через объединенный набор тэгов данных статей.
3. Если ссылка появляется во всё бОльшем количестве статей и сама в себе содержит существенную информацию (текст/описание), то возможно имеет смысл аннотировать ресурс как полноценную публикацию.


### Иерархия URL

Пользователь периодически читает материалы с нескольких крупных порталов. 
Он сохраняет ссылки на понравившиеся и полезные статьи (как в delicious).

При поиске ресурсов кроме тэгов можно использовать начальный путь ссылки, если мы помним, что ссылка была с определенного портала.


### Написание статьи, состоящий из большого количества ссылок

Вполне реальна ситуация, когда некоторая статья может состоять только из списка ссылок. 
Например, при решении некоторой проблемы чаще всего мы пользуемся поиском в интернете. Можем найти несколько ссылок со схожим описанием проблемы и предлагаемыми решениями и/или обходными путями. 
Цепочка ссылок может вести от общего описания проблемы к непосредственной проблеме и решению, т.о. важна последовательность ссылок в статье. 

Каждую ссылку можно (но не обязательно) снабдить описанием. Позднее одна ссылка может быть использована в нескольких статьях, следовательно описание этой ссылки относится к ресурсу (URL), а не к конкретному упоминанию ссылки в некоторой статье.
 

### Указание несуществующих публикаций

#### Внешние ссылки (ссылки на ресурсы)



#### Указание несуществующих статей (внутренние ссылки, тэги, свойства)

При аннотировании можно указать несуществующую статью (через тэг, внутреннюю ссылку или свойство). 
В этом случае нечего указывать в таблице ссылкок/тэгов.
Однако связь эту создать необходимо, т.к. несуществующая в данный момент статья может быть создана позже.

Варианты решения проблемы:

1. Создать директорию для несуществующей статьи. При этом мы соотносим статью с директорией, а ее текст - с файлом `.wiki` в этой директории.  

Т.о. рождается термин `требуемая статья` (аналогично википедии) - статья без текста, но накоторую есть ссылки. Можно вывести топ требуемых статей, отсортировав их по количеству ссылок.


### Переименование публикаций





Ссылка может состоять из следующих компонентов:

- Ссылка (например, http://example.org) - единственный обязательный компонент
- Заголовок
- Описание (текст статьи ресурса-ссылки)
- Способ отображения: возможность разворачивать/сворачивать, первоначальное состояние, фиксировано выделено (например как цитата).

Ссылку можно описать в свойствах статьи (внизу) и включить в текст только ее номер ([1], [2]).

При сохранении статьи для каждой ссылки:

- Если ресурса для ссылки нет, то создать его. Если ресурс есть, но с пустым заголовком/текстом, то заполнить из данной статьи. Иначе статью не сохранять, открыть пользователю в новой вкладке текст данного ресурса, в панели сообщений вывести о том, что данный ресурс уже существует в БД.
- Описание ссылки в саму статью сохранять не нужно.
- Ссылка в тексте статьи заменяется на: Id, Заголовок, Ссылка


### Хранение и представление аннотаций

В процессе редактирования статьи (presentation state) ссылки оформляются в виде URL и названий статей, никаких идентификаторов.
Ссылки в сохраненных статьях (persistance state) также должны храниться в виде URL и названий статей, никаких идентификаторов. Т.к. открыть статью могут как файл.

Однако что делать, если статьи, используемые в аннотации переименовываются или удаляются?

Предлагаю такое решение:

- текст статьи разбивается на два блока: содержательный и блок аннотаций
- с т.з. удобства парсинга (программно на сервере и на клиенте) и редактирования (пользователем) содержательный блок целесообразно расположить в начале, блок аннотаций - в конце. В качестве разделителя использовать строку "===", у которой нет интерпретации в markdown.
- Update-триггер проверяет - если произошло переименование, то для каждой статьи, ссылающейся на переименованную, выполнить переименование ссылок в блоке аннотаций.


### Тэги
 




## Структура БД

- Чтобы была возможность сохранить порядок ссылок в статье можно хранить их в тексте статьи. 
- Чтобы связи можно было учитывать при отборе списка ресурсов/статей, связи также нужно хранить в БД. Нужна отдельная таблица ссылок между статьями из двух полей: А ссылается на Б.
